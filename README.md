# Складской учет для интернет-магазина
Модуль интеграции интернет-магазина с системой складского и финансового учета [СКИФ](https://www.webnice.biz/online-scif/) по формату CommerceML.
СКИФ написан на PHP+MySQL и устанавливается на вашем сайте. Для обмена по формату CommerceML система учета и интернет-магазин могут находиться на разных серверах, но установка обеих систем в одной базе расширяет возможности интеграции.
## Инструкция по установке
1. Скопируйте файлы из архива в папку установки СКИФ на вашем сайте с сохранением структуры директорий.
2. Добавьте в файл настроек wn_settings.php в корне установки системы следующий код (это можно сделать через меню Сервис-Редактор кода):
```php
// Интеграция с интернет-магазином
$scif_actions[2090]=array('name'=>'Интернет-магазин','desc'=>'Интеграция с интернет-магазином по CommerceML','file'=>'cml','menu'=>3);
// Массив настроек для синхронизации с интернет-магазином (при необходимости, замените в массиве ID на GUID)
$cml=array(
'cml_id_type'=>'id', // тип формирования ID для новых элементов: 'id' - числовой код=ID элемента СКИФ или 'uuid()' - GUID
'class'=>array('id'=>'1','name'=>'Классификатор'), // классификатор
'owner'=>array('id'=>'1','name'=>'СКИФ','fullname'=>'СКИФ'), // владелец
'properties'=>array(
 2=>array('id'=>'2','name'=>'Бренд') // бренд (торговая марка)
 ),
'catalog'=>array('id'=>'1','name'=>'Основной каталог товаров'), // каталог
'offer'=>array('id'=>'1','name'=>'Пакет предложений (Основной каталог товаров)'), // пакет предложений
'offer_prices'=>array(2), // выгружаемые для пакета предложений типы цен. Проставьте им коды типов цен магазина в поле cml_id
'currencies'=>array('643'=>array('name'=>'руб'),'840'=>array('name'=>'USD'),'978'=>array('name'=>'EUR'),'980'=>array('name'=>'грн')),
// остаток на складе  для количества товаров в пакете предложений, может быть SQL-выражением, например: IF(n.is_service="1",1,(n.store1+n.store2))
'sql_store'=>'n.store1',
'where_spr_noms'=>'', // условие для выгрузки товаров и пакета предложений, например, n.store1>0 или n.parent IN (1,2)
// код группы в справочнике контрагентов в СКИФ, в которую будут добавляться покупатели интернет-магазина
'scif_contr_group'=>1,
// длина номера телефона для поиска и сохранения в базе
'phone_length'=>10,
// значения для создания документа в СКИФ при импорте заказа из магазина
// если задан contr, клиента берем из настроек, а не из файла
'invoice'=>array('user_insert'=1,'org'=>1,'store'=>1,'manager'=>1,'type'=>11,'price_type'=>2),
'exchange_url'=>'https://proloker.ru/admin/exchange/auto/', // адрес для автоматического обмена, получите его в панели управления CMS интернет-магазина
'username'=>'', // логин и пароль администратора сайта для автоматического обмена
'password'=>'',
// параметры автоматического обмена: import - Классификатор (товары и группы), offers - Пакет предложений (остатки и цены), only_changes - только изменения
'exchange_params'=>array('import'=>false,'offers'=>true,'only_changes'=>true),
// автоматически выгружать новые товары, группы и свойства. При false будут выгружать только те, у которых уже заполнен cml_id
'export_new_spr'=>false,
// для получения уведомлений в Телеграм
'telegram'=>$telegram
);
```
Если в вашем интернет-магазине уже есть товары, выгрузите их в файл обмена из панели управления интернет-магазина.
В файле будет видно, какой формат поля идентификатора (текстовый или числовой) используется вашим магазином.
SQL-код для создания полей доступен в СКИФ в меню "Торговля-Интернет-магазин".
Если используется числовой формат, замените в коде VARCHAR(36) на INT UNSIGNED.
Проставьте ИД нужного типа цен из вашего магазина в поле cml_id соответствующего типа цен в таблице СКИФ spr_prices.
Операции импорта и экспорта можно выполнять вручную в СКИФ из меню "Торговля-Интернет-магазин" или автоматически по расписанию.
После отладки обмена в ручном режиме, можно поставить обмен в планировщик, для этого добавьте в CRON на хостинге скрипт /cron/cml_cron.php с нужным вам расписанием.